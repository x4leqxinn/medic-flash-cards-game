<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meow-Dicina Flashcards | Estudio Tierno</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-soft: #fff5f8;
            --bg-card: #ffffff;
            --primary-pink: #ff85a1;
            --secondary-pink: #fbb1bd;
            --medical-blue: #a2d2ff;
            --medical-green: #bde0fe;
            --text-main: #5c527f;
            --text-dim: #9b9b9b;
            --danger: #ff6b6b;
            --success: #6bcb77;
            --font-family: 'Fredoka', cursive, sans-serif;
            --transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --shadow: 0 8px 20px rgba(255, 133, 161, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-soft);
            background-image:
                radial-gradient(var(--secondary-pink) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: var(--font-family);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            /* Expanded from 800px */
            margin: 0 auto;
            padding: 2rem;
            position: relative;
        }

        /* Decorative Kittens */
        .decoration {
            position: fixed;
            font-size: 2rem;
            z-index: -1;
            opacity: 0.4;
            pointer-events: none;
        }

        /* Header & Navigation */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding: 2rem;
            /* Increased padding */
            background: rgba(255, 255, 255, 0.9);
            /* Slightly more opaque */
            backdrop-filter: blur(10px);
            border-radius: 35px;
            /* More rounded */
            box-shadow: var(--shadow);
            border: 2px solid var(--secondary-pink);
        }

        .logo {
            font-size: 2.2rem;
            /* Larger logo */
            font-weight: 800;
            color: var(--primary-pink);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            /* More gap */
        }

        /* Buttons */
        .btn {
            background: white;
            border: 2px solid var(--primary-pink);
            color: var(--primary-pink);
            padding: 0.8rem 1.6rem;
            /* Larger buttons */
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            /* Bolder text */
            font-size: 1rem;
            /* Larger text */
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: 0 5px 0 var(--primary-pink);
            position: relative;
            top: 0;
        }

        .btn:hover {
            top: -2px;
            box-shadow: 0 6px 0 var(--primary-pink);
            background: var(--bg-soft);
        }

        .btn:active {
            top: 2px;
            box-shadow: 0 0px 0 var(--primary-pink);
        }

        .btn:disabled {
            border-color: #ddd;
            color: #ddd;
            box-shadow: 0 4px 0 #ddd;
            cursor: not-allowed;
            top: 0;
        }

        .btn-purple {
            border-color: var(--medical-blue);
            color: var(--medical-blue);
            box-shadow: 0 4px 0 var(--medical-blue);
        }

        .btn-purple:hover {
            box-shadow: 0 6px 0 var(--medical-blue);
        }

        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
            box-shadow: 0 4px 0 var(--danger);
        }

        /* Views */
        .view {
            display: none;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .view.active {
            display: block;
        }

        @keyframes bounceIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 3px dashed var(--secondary-pink);
        }

        .empty-state h2 {
            color: var(--text-dim);
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        /* Form */
        .card-form {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 30px;
            border: 2px solid var(--secondary-pink);
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-pink);
            font-size: 1rem;
            font-weight: 700;
        }

        .form-group textarea {
            width: 100%;
            background: #fff;
            border: 2px solid var(--secondary-pink);
            border-radius: 15px;
            padding: 1rem;
            color: var(--text-main);
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: var(--transition);
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(255, 133, 161, 0.1);
        }

        /* Grid / Library */
        .flashcards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .mini-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid transparent;
            position: relative;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .mini-card:hover {
            border-color: var(--primary-pink);
            transform: translateY(-8px) rotate(1deg);
        }

        .mini-card h3 {
            font-size: 1.25rem;
            /* Increased from 1.1rem */
            margin-bottom: 0.5rem;
            color: var(--primary-pink);
        }

        .mini-card p {
            font-size: 1rem;
            /* Increased from 0.95rem */
            color: var(--text-dim);
        }

        .delete-card {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #fff0f3;
            border: 1px solid var(--danger);
            color: var(--danger);
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .delete-card:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.2);
        }

        /* Game Area */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .game-stats {
            display: flex;
            gap: 1.5rem;
            background: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            border: 2px solid var(--secondary-pink);
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-success {
            color: var(--success);
        }

        .stat-fail {
            color: var(--danger);
        }

        /* FLIP CARD */
        .flip-card {
            background-color: transparent;
            width: 100%;
            max-width: 500px;
            height: 350px;
            perspective: 1000px;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            border-radius: 30px;
            font-size: 1.8rem;
            /* Increased from 1.6rem */
            font-weight: 600;
            /* Bolder */
            box-shadow: 0 15px 40px rgba(255, 133, 161, 0.2);
            border: 4px solid white;
        }

        .flip-card-front {
            background: linear-gradient(135deg, white, #fff0f3);
            color: var(--text-main);
        }

        .flip-card-back {
            background: linear-gradient(135deg, #fff0f3, white);
            color: var(--primary-pink);
            transform: rotateY(180deg);
            border-color: var(--medical-blue);
        }

        .flip-card::after {
            content: "üêæ";
            position: absolute;
            bottom: -15px;
            right: -15px;
            font-size: 2rem;
            transform: rotate(20deg);
        }

        .game-controls {
            display: flex;
            gap: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .game-controls.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(-10px);
        }

        /* Results */
        .results-view {
            text-align: center;
            background: white;
            padding: 3rem;
            border-radius: 40px;
            box-shadow: var(--shadow);
            border: 3px solid var(--secondary-pink);
        }

        .results-view h2 {
            font-size: 2.2rem;
            margin-bottom: 2rem;
            color: var(--primary-pink);
        }

        /* Toast notifications */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border: 2px solid var(--primary-pink);
            border-radius: 20px;
            padding: 1rem 2rem;
            transform: translateX(200%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            box-shadow: var(--shadow);
            color: var(--primary-pink);
            font-weight: 600;
        }

        #toast.show {
            transform: translateX(0);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-soft);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-pink);
            border-radius: 10px;
            border: 3px solid var(--bg-soft);
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1rem;
            }

            .flip-card {
                height: 300px;
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .setup-cat-item {
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .setup-cat-item:hover {
            border-color: var(--medical-blue);
            background: #f0f8ff;
            transform: translateX(5px);
        }

        .setup-cat-item input[type="checkbox"] {
            accent-color: var(--primary-pink);
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="decoration" style="top: 10%; left: 5%;">üê±</div>
    <div class="decoration" style="top: 20%; right: 8%;">ü©∫</div>
    <div class="decoration" style="bottom: 15%; left: 7%;">üíä</div>
    <div class="decoration" style="bottom: 10%; right: 5%;">üêæ</div>
    <div class="decoration" style="top: 40%; left: 2%;">‚ù§Ô∏è</div>

    <div class="container">
        <header>
            <div class="logo">üê± Kustman</div>
            <nav class="nav-buttons">
                <button class="btn" id="nav-home">üìö Mis Notas</button>
                <button class="btn btn-purple" id="nav-add">‚ú® Nueva</button>
                <button class="btn" id="start-game-btn" disabled>üéÆ Estudiar</button>
            </nav>
        </header>

        <!-- HOME VIEW (Library) -->
        <main id="view-home" class="view active">
            <div id="empty-container" class="empty-state">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üò¥</div>
                <h2>Tu malet√≠n est√° vac√≠o...</h2>
                <button class="btn btn-purple" onclick="prepareEditCard()">Crear mi primera tarjeta ü©π</button>
            </div>

            <div id="library-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-weight: 600; color: var(--text-main);">Mis Tarjetas M√©dicas ü©∫</h2>
                    <button class="btn btn-danger" onclick="clearAllCards()"
                        style="padding: 0.5rem 1rem; font-size: 0.7rem;">Vaciar Malet√≠n</button>
                </div>
                <div class="flashcards-grid" id="cards-grid">
                    <!-- Cards injection -->
                </div>
            </div>
        </main>

        <!-- CATEGORIES VIEW -->
        <section id="view-categories" class="view">
            <h2 style="margin-bottom: 2rem; color: var(--primary-pink); text-align: center;">üìÇ Gesti√≥n de Categor√≠as
            </h2>

            <div class="card-form" style="margin-bottom: 2rem;">
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="cat-name-input" placeholder="Nombre de la categor√≠a..."
                        style="flex:1; padding: 0.8rem; border-radius: 15px; border: 2px solid var(--secondary-pink); outline:none;">
                    <button class="btn" id="btn-save-cat" onclick="saveCategory()">‚ú® Crear Categor√≠a</button>
                </div>
            </div>

            <div class="flashcards-grid" id="categories-list">
                <!-- Categories Injection -->
            </div>
        </section>

        <!-- GAME SETUP VIEW -->
        <section id="view-setup" class="view">
            <div class="results-view" style="max-width: 600px; margin: 0 auto; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üéí</div>
                <h2 style="margin-bottom: 1rem;">¬øQu√© vamos a estudiar hoy?</h2>
                <p style="color: var(--text-dim); margin-bottom: 2rem;">Selecciona las categor√≠as que quieres repasar
                </p>

                <div class="flashcards-grid" id="setup-categories-list"
                    style="margin-bottom: 2rem; grid-template-columns: 1fr; text-align: left;">
                    <!-- Setup List Injection -->
                </div>

                <button class="btn btn-purple"
                    style="width: 100%; justify-content: center; font-size: 1.2rem; padding: 1rem;"
                    onclick="startGameFromSetup()">üöÄ ¬°A Estudiar!</button>
            </div>
        </section>

        <!-- ADD VIEW -->
        <section id="view-add" class="view">
            <div class="card-form">
                <h2 id="form-title" style="margin-bottom: 2rem; color: var(--primary-pink); text-align: center;">üçé
                    Nueva Tarjeta de Estudio</h2>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="card-category"
                        style="width: 100%; padding: 0.8rem; border-radius: 15px; border: 2px solid var(--secondary-pink); background: white; outline: none; color: var(--text-main);">
                        <!-- Options injected via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Frente (Concepto o S√≠ntoma)</label>
                    <textarea id="card-front" placeholder="Ej: Anatom√≠a del coraz√≥n..."></textarea>
                </div>
                <div class="form-group">
                    <label>Reverso (Tratamiento o Definici√≥n)</label>
                    <textarea id="card-back" placeholder="Escribe la respuesta aqu√≠..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                    <button class="btn" style="background: var(--primary-pink); color: white;" onclick="saveCard()">üíñ
                        Guardar</button>
                    <button class="btn" style="border-color: #ccc; color: #999; box-shadow: 0 4px 0 #ccc;"
                        onclick="showView('home')">Cancelar</button>
                </div>
            </div>
        </section>

        <!-- GAME VIEW -->
        <section id="view-game" class="view">
            <div class="game-container">
                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-value" id="current-card-idx">1</span>
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-weight: 600;">PASO</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value stat-success" id="success-count">0</span>
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-weight: 600;">LOGRADO</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value stat-fail" id="fail-count">0</span>
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-weight: 600;">REPASAR</span>
                    </div>
                </div>

                <div class="flip-card" id="main-flip-card">
                    <div class="flip-card-inner">
                        <div class="flip-card-front" id="game-front">
                            <!-- Question -->
                        </div>
                        <div class="flip-card-back" id="game-back">
                            <!-- Answer -->
                        </div>
                    </div>
                </div>

                <p
                    style="color: var(--primary-pink); font-size: 0.9rem; font-weight: 600; animation: pulse 2s infinite;">
                    üêæ TOCA PARA REVELAR LA RESPUESTA üêæ</p>

                <div class="game-controls" id="game-controls">
                    <button class="btn btn-danger" onclick="handleGameAnswer(false)">üòø No lo supe</button>
                    <button class="btn"
                        style="border-color: var(--success); color: var(--success); box-shadow: 0 4px 0 var(--success);"
                        onclick="handleGameAnswer(true)">üò∏ ¬°Lo supe!</button>
                </div>
            </div>
        </section>

        <!-- RESULTS VIEW -->
        <section id="view-results" class="view results-view">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
            <h2>¬°Excelente Guardi√°n!</h2>
            <p style="margin-bottom: 2rem; color: var(--text-dim);">Has completado tu ronda de estudio.</p>
            <div class="game-stats"
                style="justify-content: center; margin-bottom: 3rem; border: none; box-shadow: none;">
                <div class="stat">
                    <span class="stat-value stat-success" id="final-success">0</span>
                    <span style="font-weight: 600;">√âXITOS</span>
                </div>
                <div style="width: 2px; background: #eee; margin: 0 1rem;"></div>
                <div class="stat">
                    <span class="stat-value stat-fail" id="final-fail">0</span>
                    <span style="font-weight: 600;">FALLOS</span>
                </div>
            </div>
            <button class="btn"
                style="background: var(--medical-blue); border-color: var(--medical-blue); color: white; box-shadow: 0 4px 0 #7fb9f0;"
                onclick="showView('home')">Volver al Inicio üò∫</button>
        </section>
    </div>

    <div id="toast">¬°Tarjeta guardada con √©xito! üêæ</div>

    <style>
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }
    </style>

    <script>
        // --- State Management ---
        const LS_KEY = 'yuki_flashcards_app';
        const LS_KEY_CATS = 'yuki_flashcards_cats';

        // Default Data
        let flashcards = [];
        let categories = [];

        // Load Data & Migrate
        function loadData() {
            const storedCards = localStorage.getItem(LS_KEY);
            const storedCats = localStorage.getItem(LS_KEY_CATS);

            if (storedCats) {
                categories = JSON.parse(storedCats);
            } else {
                categories = [{ id: 'default', name: 'General üåü' }];
                localStorage.setItem(LS_KEY_CATS, JSON.stringify(categories));
            }

            if (storedCards) {
                flashcards = JSON.parse(storedCards);
                // Migration: Assign 'default' category if missing
                let migrated = false;
                flashcards.forEach(card => {
                    if (!card.categoryId) {
                        card.categoryId = 'default';
                        migrated = true;
                    }
                });
                if (migrated) localStorage.setItem(LS_KEY, JSON.stringify(flashcards));
            }
        }

        let gameState = {
            selectedCategories: [],
            shuffled: [],
            currentIndex: 0,
            success: 0,
            fail: 0
        };

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const cardsGrid = document.getElementById('cards-grid');
        const emptyContainer = document.getElementById('empty-container');
        const libraryContainer = document.getElementById('library-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const mainFlipCard = document.getElementById('main-flip-card');
        const categorySelect = document.getElementById('card-category');
        const gameSetupGrid = document.getElementById('game-setup-grid');

        // --- Navigation ---
        function showView(viewId) {
            views.forEach(v => v.classList.remove('active'));
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.classList.add('active');
            }

            if (viewId === 'home') renderLibrary();
            if (viewId === 'categories') renderCategories(); // New view
            if (viewId === 'setup') renderGameSetup();      // New view
            window.scrollTo(0, 0);
        }

        document.getElementById('nav-home').addEventListener('click', () => showView('home'));
        document.getElementById('nav-add').addEventListener('click', () => prepareEditCard()); // Modified to support clean add
        startGameBtn.addEventListener('click', () => showView('setup')); // Changed to Setup view

        // Add Category Nav Button
        const navContainer = document.querySelector('.nav-buttons');
        const catBtn = document.createElement('button');
        catBtn.className = 'btn';
        catBtn.innerHTML = 'üìÇ Categor√≠as';
        catBtn.onclick = () => showView('categories');
        navContainer.insertBefore(catBtn, document.getElementById('nav-add'));


        // --- Category Logic ---
        function saveCategory() {
            const nameInput = document.getElementById('cat-name-input');
            const name = nameInput.value.trim();
            if (!name) return showToast('¬°El nombre no puede estar vac√≠o! üòø', true);

            const editingId = nameInput.dataset.editingId;

            if (editingId) {
                const cat = categories.find(c => c.id === editingId);
                if (cat) cat.name = name;
                delete nameInput.dataset.editingId;
                document.getElementById('btn-save-cat').textContent = '‚ú® Crear Categor√≠a';
                showToast('Categor√≠a actualizada üìù');
            } else {
                const newCat = { id: Date.now().toString(), name };
                categories.push(newCat);
                showToast('Categor√≠a creada ‚ú®');
            }

            localStorage.setItem(LS_KEY_CATS, JSON.stringify(categories));
            nameInput.value = '';
            renderCategories();
        }

        function editCategory(id) {
            const cat = categories.find(c => c.id === id);
            if (!cat) return;
            const input = document.getElementById('cat-name-input');
            input.value = cat.name;
            input.dataset.editingId = id;
            document.getElementById('btn-save-cat').innerHTML = 'üíæ Guardar Cambios';
            window.scrollTo(0, 0);
        }

        function deleteCategory(id) {
            if (id === 'default') return showToast('No puedes borrar la categor√≠a por defecto üö´', true);

            // Check if cards exist in this category
            const hasCards = flashcards.some(c => c.categoryId === id);
            if (hasCards) {
                if (!confirm('Esta categor√≠a tiene cartas. ¬øDeseas borrarla y mover sus cartas a "General"?')) return;
                flashcards.forEach(c => {
                    if (c.categoryId === id) c.categoryId = 'default';
                });
                localStorage.setItem(LS_KEY, JSON.stringify(flashcards));
            } else {
                if (!confirm('¬øBorrar categor√≠a?')) return;
            }

            categories = categories.filter(c => c.id !== id);
            localStorage.setItem(LS_KEY_CATS, JSON.stringify(categories));

            // Reset form if editing this one
            const input = document.getElementById('cat-name-input');
            if (input.dataset.editingId === id) {
                input.value = '';
                delete input.dataset.editingId;
                document.getElementById('btn-save-cat').textContent = '‚ú® Crear Categor√≠a';
            }

            renderCategories();
            showToast('Categor√≠a eliminada üóëÔ∏è');
        }

        function renderCategories() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';

            if (categories.length === 0) { // Should technically not happen due to default
                categories = [{ id: 'default', name: 'General üåü' }];
            }

            categories.forEach(cat => {
                const el = document.createElement('div');
                el.className = 'mini-card';
                el.style.display = 'flex';
                el.style.justifyContent = 'space-between';
                el.style.alignItems = 'center';
                el.innerHTML = `
                    <h3 style="margin:0">${cat.name}</h3>
                    <div style="display:flex; gap:0.5rem">
                        <button class="btn" style="padding: 0.3rem 0.6rem; font-size:0.8rem" onclick="editCategory('${cat.id}')">‚úèÔ∏è</button>
                        ${cat.id !== 'default' ? `<button class="btn btn-danger" style="padding: 0.3rem 0.6rem; font-size:0.8rem" onclick="deleteCategory('${cat.id}')">üóëÔ∏è</button>` : ''}
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- Card CRUD Logic ---
        let editingCardId = null;

        function prepareEditCard(id = null) {
            editingCardId = id;
            const frontInput = document.getElementById('card-front');
            const backInput = document.getElementById('card-back');
            const catSelect = document.getElementById('card-category');

            // Safety: Ensure categories exist
            if (categories.length === 0) {
                categories = [{ id: 'default', name: 'General üåü' }];
                localStorage.setItem(LS_KEY_CATS, JSON.stringify(categories));
            }

            // Populate Categories Dropdown

            // Populate Categories Dropdown
            catSelect.innerHTML = '';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                catSelect.appendChild(opt);
            });

            if (id) {
                const card = flashcards.find(c => c.id === id);
                if (card) {
                    frontInput.value = card.front;
                    backInput.value = card.back;
                    catSelect.value = card.categoryId || 'default';
                    document.getElementById('form-title').textContent = '‚úèÔ∏è Editar Tarjeta';
                }
            } else {
                frontInput.value = '';
                backInput.value = '';
                if (categories.length > 0) catSelect.value = categories[0].id; // Default to first
                document.getElementById('form-title').textContent = 'üçé Nueva Tarjeta';
            }

            showView('add');
        }

        function saveCard() {
            const front = document.getElementById('card-front').value.trim();
            const back = document.getElementById('card-back').value.trim();
            const categoryId = document.getElementById('card-category').value;

            if (!front || !back) {
                showToast('¬°Ay! Faltan datos en la receta ü©∫', true);
                return;
            }

            if (editingCardId) {
                // Update existing
                const card = flashcards.find(c => c.id === editingCardId);
                if (card) {
                    card.front = front;
                    card.back = back;
                    card.categoryId = categoryId;
                    showToast('Tarjeta actualizada üìù');
                }
            } else {
                // Create new
                const newCard = {
                    id: Date.now(),
                    front,
                    back,
                    categoryId
                };
                flashcards.push(newCard);
                showToast('¬°Tarjeta guardada! üêæ');
            }

            localStorage.setItem(LS_KEY, JSON.stringify(flashcards));
            showView('home');
        }

        function deleteCard(id) {
            if (!confirm('¬øDeseas eliminar este registro m√©dico? üòø')) return;
            flashcards = flashcards.filter(c => c.id !== id);
            localStorage.setItem(LS_KEY, JSON.stringify(flashcards));
            renderLibrary();
            showToast('Registro eliminado üóëÔ∏è');
        }

        function clearAllCards() {
            if (!confirm('¬øBORRAR TODO EL MALET√çN? üéí Esta acci√≥n es permanente.')) return;
            flashcards = [];
            localStorage.setItem(LS_KEY, JSON.stringify(flashcards));
            renderLibrary();
        }

        function renderLibrary() {
            cardsGrid.innerHTML = '';

            if (flashcards.length === 0) {
                emptyContainer.style.display = 'block';
                libraryContainer.style.display = 'none';
                startGameBtn.disabled = true;
                return;
            }

            emptyContainer.style.display = 'none';
            libraryContainer.style.display = 'block';
            startGameBtn.disabled = false;

            // Group by Category
            const cardsByCat = {};
            categories.forEach(cat => cardsByCat[cat.id] = []);
            flashcards.forEach(card => {
                const catId = card.categoryId || 'default';
                if (!cardsByCat[catId]) cardsByCat[catId] = []; // Handle Deleted Categories
                cardsByCat[catId].push(card);
            });

            // Render Groups
            for (const catId in cardsByCat) {
                const cards = cardsByCat[catId];
                if (cards.length === 0) continue;

                const category = categories.find(c => c.id === catId) || { name: 'Sin Categor√≠a üïµÔ∏è‚Äç‚ôÄÔ∏è' };

                const groupTitle = document.createElement('h3');
                groupTitle.style.gridColumn = '1 / -1';
                groupTitle.style.marginTop = '1rem';
                groupTitle.style.color = 'var(--text-dim)';
                groupTitle.style.borderBottom = '2px dashed var(--medical-green)';
                groupTitle.style.paddingBottom = '0.5rem';
                groupTitle.textContent = category.name;
                cardsGrid.appendChild(groupTitle);

                cards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'mini-card';
                    cardEl.innerHTML = `
                        <div style="position:absolute; top:10px; right:10px; display:flex; gap:0.3rem">
                            <button class="delete-card" style="position:static; width:30px; height:30px; background:#e0f7fa; color:var(--medical-blue); border-color:var(--medical-blue)" onclick="prepareEditCard(${card.id})">‚úèÔ∏è</button>
                            <button class="delete-card" style="position:static; width:30px; height:30px;" onclick="deleteCard(${card.id})">√ó</button>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--medical-blue); margin-bottom: 0.3rem;">üìã Registro #${card.id.toString().slice(-4)}</div>
                        <h3>${card.front}</h3>
                        <p>${card.back.substring(0, 100)}${card.back.length > 100 ? '...' : ''}</p>
                    `;
                    cardsGrid.appendChild(cardEl);
                });
            }
        }

        // --- Game Setup Logic ---
        function renderGameSetup() {
            const container = document.getElementById('setup-categories-list');
            container.innerHTML = '';

            // Checkbox for "All"
            const allDiv = document.createElement('div');
            allDiv.className = 'mini-card';
            allDiv.style.cursor = 'pointer';
            allDiv.style.display = 'flex';
            allDiv.style.alignItems = 'center';
            allDiv.style.gap = '1rem';
            allDiv.style.background = '#eef';
            allDiv.innerHTML = `
                <input type="checkbox" id="setup-cat-all" style="transform: scale(1.5);">
                <h3 style="margin:0">Seleccionar Todo üåç</h3>
            `;
            allDiv.onclick = (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const cb = document.getElementById('setup-cat-all');
                    cb.checked = !cb.checked;
                    toggleAllCats(cb.checked);
                } else {
                    toggleAllCats(e.target.checked);
                }
            };
            container.appendChild(allDiv);

            // Individual Categories
            categories.forEach(cat => {
                // Only show categories that have cards
                const count = flashcards.filter(c => (c.categoryId || 'default') === cat.id).length;
                if (count === 0) return;

                const div = document.createElement('div');
                div.className = 'mini-card setup-cat-item';
                div.setAttribute('data-id', cat.id);
                div.style.cursor = 'pointer';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:1rem">
                        <input type="checkbox" class="setup-cb" value="${cat.id}" style="transform: scale(1.5);">
                        <h3 style="margin:0">${cat.name}</h3>
                    </div>
                    <span style="background:var(--secondary-pink); color:white; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.8rem">${count} cartas</span>
                `;
                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                container.appendChild(div);
            });
        }

        function toggleAllCats(checked) {
            document.querySelectorAll('.setup-cb').forEach(cb => cb.checked = checked);
        }

        function startGameFromSetup() {
            const selectedIds = Array.from(document.querySelectorAll('.setup-cb:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return showToast('¬°Debes elegir al menos una categor√≠a! üòº', true);

            // Filter Cards
            const cardsToPlay = flashcards.filter(c => selectedIds.includes(c.categoryId || 'default'));
            initGame(cardsToPlay);
        }

        // --- Game Logic ---
        function initGame(cards) {
            if (!cards || cards.length === 0) return;

            gameState.shuffled = [...cards].sort(() => Math.random() - 0.5);
            gameState.currentIndex = 0;
            gameState.success = 0;
            gameState.fail = 0;

            updateGameUI();
            showView('game');
        }

        function updateGameUI() {
            const card = gameState.shuffled[gameState.currentIndex];
            const frontEl = document.getElementById('game-front');
            const backEl = document.getElementById('game-back');

            mainFlipCard.classList.remove('flipped');
            document.getElementById('game-controls').classList.remove('show');

            frontEl.textContent = card.front;
            backEl.textContent = card.back;

            document.getElementById('current-card-idx').textContent = `${gameState.currentIndex + 1}/${gameState.shuffled.length}`;
            document.getElementById('success-count').textContent = gameState.success;
            document.getElementById('fail-count').textContent = gameState.fail;
        }

        mainFlipCard.addEventListener('click', () => {
            mainFlipCard.classList.toggle('flipped');
            if (mainFlipCard.classList.contains('flipped')) {
                document.getElementById('game-controls').classList.add('show');
            }
        });

        function handleGameAnswer(isCorrect) {
            if (isCorrect) gameState.success++;
            else gameState.fail++;

            gameState.currentIndex++;

            if (gameState.currentIndex < gameState.shuffled.length) {
                updateGameUI();
            } else {
                finishGame();
            }
        }

        function finishGame() {
            const total = gameState.success + gameState.fail;
            const successRate = total === 0 ? 0 : (gameState.success / total);

            document.getElementById('final-success').textContent = gameState.success;
            document.getElementById('final-fail').textContent = gameState.fail;

            const titleObj = document.querySelector('#view-results h2');
            const msgObj = document.querySelector('#view-results p');
            const emojiObj = document.querySelector('#view-results div[style*="font-size: 4rem"]');

            if (gameState.fail === 0 && total > 0) {
                // Perfect Score
                emojiObj.textContent = 'üèÜ';
                titleObj.textContent = 'EXCELENTE! üåü';
                titleObj.style.color = 'var(--success)';
                msgObj.textContent = '¬°Eres la mejor!, te adoro. üòª';
            } else if (successRate < 0.5) {
                // High Failure Rate (< 50%)
                emojiObj.textContent = 'ü©π';
                titleObj.textContent = '¬°√Ånimo Anto! ‚ù§Ô∏è‚Äçü©π';
                titleObj.style.color = 'var(--text-main)';
                msgObj.textContent = 'No te desanimes. ¬°Vuelve a intentarlo!';
            } else {
                // Normal
                emojiObj.textContent = 'üéâ';
                titleObj.textContent = '¬°Muy bien!';
                titleObj.style.color = 'var(--primary-pink)';
                msgObj.innerHTML = 'Has completado tu ronda de estudio.<br>Sigue as√≠ bb uwu.';
            }

            showView('results');
        }

        // --- UI Helpers ---
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.borderColor = isError ? 'var(--danger)' : 'var(--primary-pink)';
            toast.style.color = isError ? 'var(--danger)' : 'var(--primary-pink)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- Initial Load ---
        loadData();
        renderLibrary();
    </script>
</body>

</html>